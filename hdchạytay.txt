xem chi ti·∫øt n·ªôi dung b·∫£ng attendance
SELECT * FROM attendance_source;
====================================================
Giai ƒëo·∫°n 1: B·∫≠t H·∫° T·∫ßng & D·ªçn D·∫πp 

1. B·∫≠t Docker Containers:

M·ªü Docker Desktop.

T√¨m 2 container: rabbitmq-payroll v√† mysql-payroll.

Nh·∫•n n√∫t Play (‚ñ∂) ƒë·ªÉ b·∫≠t ch√∫ng l√™n (ƒë·ª£i chuy·ªÉn sang m√†u xanh l√°).

2. D·ªçn s·∫°ch d·ªØ li·ªáu c≈© (MySQL Workbench):

M·ªü MySQL Workbench, k·∫øt n·ªëi v√†o CSDL payroll.

M·ªü m·ªôt tab Query m·ªõi, ch·∫°y ƒëo·∫°n l·ªánh n√†y ƒë·ªÉ x√≥a tr·∫Øng m·ªçi th·ª©:

SQL

-- X√≥a s·∫°ch d·ªØ li·ªáu c≈© ƒë·ªÉ ch·∫°y demo m·ªõi
TRUNCATE staging_records;
TRUNCATE dedup_unique;
TRUNCATE dedup_duplicate;
TRUNCATE employees;
TRUNCATE attendance;
Check: L√∫c n√†y c√°c b·∫£ng ƒë√≠ch s·∫Ω tr·ªëng r·ªóng.

3. D·ªçn s·∫°ch H√†ng ƒë·ª£i (RabbitMQ Web UI):

V√†o tr√¨nh duy·ªát: http://localhost:15672 (User/Pass: guest/guest).

V√†o tab Queues -> Ch·ªçn staging_queue.

K√©o xu·ªëng d∆∞·ªõi, b·∫•m Purge Messages (n·∫øu c√≥ tin nh·∫Øn c≈© t·ªìn ƒë·ªçng).
Giai ƒëo·∫°n 2: Ch·∫°y Code Java (Extract & Load Staging)
Ch√∫ng ta s·∫Ω ch·∫°y t·ª´ng th√†nh ph·∫ßn trong VS Code.

1. B·∫≠t Consumer (Ng∆∞·ªùi nh·∫≠n) tr∆∞·ªõc:

Trong VS Code, m·ªü file: src/main/java/com/example/consumer/StagingConsumer.java.

Nh·∫•n n√∫t Run (‚ñ∂) ·ªü g√≥c tr√™n b√™n ph·∫£i.

Quan s√°t Terminal: Khi th·∫•y d√≤ng ‚ñ∂Ô∏è Consumer ƒëang ch·∫°y... th√¨ ƒë·ªÉ y√™n ƒë√≥.

2. B·∫≠t Producer (Ng∆∞·ªùi g·ª≠i) sau:

Trong VS Code, m·ªü file: src/main/java/com/example/RunProducer.java.

Nh·∫•n n√∫t Run (‚ñ∂).

3. Ki·ªÉm tra k·∫øt qu·∫£ t·ª©c th·ªùi:

Quay l·∫°i c·ª≠a s·ªï Consumer, th·∫•y n√≥ ch·∫°y li√™n t·ª•c c√°c d√≤ng: ‚úÖ ƒê√£ x·ª≠ l√Ω v√† INSERT th√†nh c√¥ng....

L√∫c n√†y, 594 b·∫£n ghi (297 nh√¢n vi√™n + 297 ch·∫•m c√¥ng) ƒë√£ n·∫±m trong b·∫£ng staging_records.

xem b·∫£ng stagingrecord b·∫±ng c√°ch

SELECT source_name, COUNT(*) 
FROM staging_records 
GROUP BY source_name;

‚öôÔ∏è Giai ƒëo·∫°n 3: X·ª≠ l√Ω Logic (Transform & Deduplicate)
L√∫c n√†y d·ªØ li·ªáu ƒëang ·ªü d·∫°ng th√¥ v√† h·ªón ƒë·ªôn trong staging_records. Ch√∫ng ta c·∫ßn ch·∫°y SQL ƒë·ªÉ l·ªçc v√† s·∫Øp x·∫øp.

Thao t√°c trong MySQL Workbench:

M·ªü tab Query m·ªõi.

Copy ƒëo·∫°n code sau (Logic ch√≠nh c·ªßa ƒë·ªì √°n) v√† nh·∫•n Tia s√©t 
--------------------

-- 1. L·ªåC S·∫†CH (T√°ch b·∫£n ghi duy nh·∫•t)
INSERT INTO dedup_unique(business_key, record_type, representative_source, payload_json)
SELECT business_key, record_type, JSON_EXTRACT(sources, '$[0]'), sample_payload
FROM (
    SELECT record_type, business_key, COUNT(*) AS cnt, JSON_ARRAYAGG(source_name) AS sources, ANY_VALUE(payload_json) AS sample_payload
    FROM staging_records GROUP BY record_type, business_key
) AS grouped WHERE cnt = 1;

-- 2. L·ªåC TR√ôNG (T√°ch b·∫£n ghi tr√πng l·∫∑p ƒë·ªÉ b√°o c√°o)
INSERT INTO dedup_duplicate(business_key, record_type, conflict_count, sources, sample_payload)
SELECT business_key, record_type, cnt, sources, sample_payload
FROM (
    SELECT record_type, business_key, COUNT(*) AS cnt, JSON_ARRAYAGG(source_name) AS sources, ANY_VALUE(payload_json) AS sample_payload
    FROM staging_records GROUP BY record_type, business_key
) AS grouped WHERE cnt > 1;

-- 3. N·∫†P B·∫¢NG ƒê√çCH (Chuy·ªÉn d·ªØ li·ªáu s·∫°ch v√†o kho ch√≠nh th·ª©c)
-- N·∫°p Nh√¢n vi√™n
INSERT INTO employees (emp_id, name, department, base_salary, allowance)
SELECT JSON_UNQUOTE(JSON_EXTRACT(payload_json, '$.emp_id')), JSON_UNQUOTE(JSON_EXTRACT(payload_json, '$.name')), JSON_UNQUOTE(JSON_EXTRACT(payload_json, '$.department')), JSON_EXTRACT(payload_json, '$.base_salary'), JSON_EXTRACT(payload_json, '$.allowance')
FROM dedup_unique WHERE record_type = 'employees';

-- N·∫°p Ch·∫•m c√¥ng
INSERT INTO attendance (emp_id, work_date, check_in, check_out, ot_hours)
SELECT JSON_UNQUOTE(JSON_EXTRACT(payload_json, '$.emp_id')), JSON_UNQUOTE(JSON_EXTRACT(payload_json, '$.work_date')), JSON_UNQUOTE(JSON_EXTRACT(payload_json, '$.check_in')), JSON_UNQUOTE(JSON_EXTRACT(payload_json, '$.check_out')), JSON_EXTRACT(payload_json, '$.ot_hours')
FROM dedup_unique WHERE record_type = 'attendance';
--------------
üèÜ Giai ƒëo·∫°n 4: Ki·ªÉm tra & Xu·∫•t B√°o c√°o (K·∫øt th√∫c)
Trong MySQL Workbench, ch·∫°y l·ªánh:

SQL

-- Xem k·∫øt qu·∫£ Nh√¢n vi√™n (Ph·∫£i ~295 d√≤ng)
SELECT * FROM employees;

-- Xem k·∫øt qu·∫£ Ch·∫•m c√¥ng (Ph·∫£i ~295 d√≤ng)
SELECT * FROM attendance;

-- Xem c√°c b·∫£n ghi tr√πng l·∫∑p b·ªã b·∫Øt l·∫°i (V√≠ d·ª• E001, E002)
SELECT * FROM dedup_duplicate;

--xem b·∫£ng t·ªïng h·ª£p t·ª´ nh√¢n vi√™n v√† ch·∫•m c√¥nng 
SELECT 
    -- 1. Th√¥ng tin t·ª´ b·∫£ng Nh√¢n vi√™n (employees)
    e.emp_id      AS 'M√£ NV',
    e.name        AS 'H·ªç T√™n',
    e.department  AS 'Ph√≤ng Ban',
    e.base_salary AS 'L∆∞∆°ng C∆° B·∫£n',
    
    -- 2. Th√¥ng tin t·ª´ b·∫£ng Ch·∫•m c√¥ng (attendance)
    a.work_date   AS 'Ng√†y L√†m',
    a.check_in    AS 'Gi·ªù V√†o',
    a.check_out   AS 'Gi·ªù Ra',
    a.ot_hours    AS 'Gi·ªù TƒÉng Ca'

FROM employees e
JOIN attendance a ON e.emp_id = a.emp_id;